    <section anchor="cdnifcimap" title="CDNI FCI Map">
    	<t>
          The ALTO protocol is based on an ALTO Information Service Framework which consists of several services, where all ALTO services are "provided through a common transport protocol, messaging structure and encoding, and transaction model" <xref target="RFC7285" pageno="false" format="default"/>. The ALTO protocol specification <xref target="RFC7285" pageno="false" format="default"/> defines several such services, e.g. the ALTO map service.
      </t>

      <t>
          This document defines a new ALTO Map Service called "CDNI FCI Map Service" which conveys JSON objects of media type "application/alto-cdnifcimap+json". These JSON objects are used to transport BaseAdvertisementObject objects defined in <xref target="RFC8008"/>; this document specifies how to transport such BaseAdvertisementObject objects via the ALTO protocol with the ALTO "CDNI FCI Map Service". Given that the "CDNI FCI Map Service" is very similar in structure to the two already defined map services (network maps and cost maps), the specification of CDNI FCI Map below uses the same specification structure for Cost Map specification in Section 11.2.3 of <xref target="RFC7285" pageno="false" format="default"/> when specifying cost maps.
        </t>
    	<section title="Media Type" anchor="cdnifcimapmediatype">
    		<t>
    		    The media type of the CDNI FCI Map is "application/alto-cdnifcimap+json".
    		</t>
    	</section>
    	<section title="HTTP Method">
    		<t>
    		    A CDNI FCI map resource is requested using the HTTP GET method.
    		</t>
    	</section>
    	<section title="Accept Input Parameters">
    		<t>
    		    None.
    		</t>
    	</section>
    	<section title="Capabilities">
    		<t>
    			None.
    		</t>
    	</section>
    	<section title="Uses">
    		<t>
    		    The resource ID of the resource based on which the CDNI FCI map will be defined. For example, if a CDNI FCI map depends on a network map, the resource ID of the network map MUST be included in "uses" field. Please see <xref target="cdnifcinetworkmap"/> for details. If the CDNI FCI map does not depend on any other resources, "uses" field MUST NOT appear.
    		</t>
    	</section>
    	<section title="Response" anchor="cdnifcimapencoding">
    		<t>
    			The "meta" field of a CDNI FCI map response MUST include the "vtag" field defined in Section 10.3 of <xref target="RFC7285" pageno="false" format="default"/>. This field provides the version of the retrieved CDNI FCI map.</t>

        <t>
          If a CDNI FCI map response depends on a resource such as a network map, it MUST include the "dependent-vtags" field, whose value is an array to indicate the version tags of the resources used, where each resource is specified in "uses" of the IRD. The current defined dependent resource is only network map, and the usage of it is described in <xref target="cdnifcinetworkmap"/>.
        </t>
        <t>
    			The data component of an ALTO CDNI FCI map response is named "cdni-fci-map", which is a JSON object of type CDNIFCIMapData:
    		</t>
        <figure align="left">
              <artwork align="left"><![CDATA[
    object {
        CDNIFCIMapData cdni-fci-map;
    } InfoResourceCDNIFCIMap : ResponseEntityBase;

    object {
        BaseAdvertisementObject capabilities<1..*>;
    } CDNIFCIMapData;
                ]]></artwork>
        </figure>
            <t>
              Specifically, a CDNIFCIMapData object is a JSON object that includes only one property named "capabilities", whose value is an array of BaseAdvertisementObject objects.
            </t>

            <t>
              The syntax and semantics of BaseAdvertisementObject are well defined in Section 5.1 of <xref target="RFC8008" pageno="false" format="default"/>. A BaseAdvertisementObject object includes multiple properties, including capability-type, capability-value and footprints, where footprints are defined in Section 4.2.2.2 of <xref target="RFC8006" pageno="false" format="default"/>.
            </t>

            <t>
              To be self-contained, we give a non-normative specification of BaseAdvertisementObject below. As mentioned above, the normative specification of BaseAdvertisementObject is in <xref target="RFC8008" pageno="false" format="default"/>
            </t>
        <figure align="left">
              <artwork align="left"><![CDATA[
    object {
        JSONString capability-type;
        JSONValue capability-value;
        Footprint footprints<0..*>;
    } BaseAdvertisementObject;

    object {
        JSONString footprint-type;
        JSONString footprint-value<1..*>;
    } Footprint;
                ]]></artwork>
        </figure>
            <t>
                For each BaseAdvertisementObject, the ALTO client MUST interpret footprints appearing multiple times as if they appeared only once. If footprints in a BaseAdvertisementObject is null or empty or not appearing, the ALTO client MUST understand that the capabilities in this BaseAdvertisementObject have the "global" coverage.
            </t>
            <t>
                Note: Further optimization of BaseAdvertisement objects to effectively provide the advertisement of capabilities with footprint restrictions is certainly possible. For example, these two examples below both describe that the dCDN can provide capabilities ["http/1.1", "https/1.1"] for the same footprints. However, the latter one is smaller in its size.
        <figure align="left">
              <artwork align="left"><![CDATA[
EXAMPLE 1
    {
      "meta" : {...},
      "cdni-fci-map": {
        "capabilities": [
          {
            "capability-type": "FCI.DeliveryProtocol",
            "capability-value": {
              "delivery-protocols": [
                "http/1.1"
              ]
            },
            "footprints": [
              <Footprint objects>
            ]
          },
          {
            "capability-type": "FCI.DeliveryProtocol",
            "capability-value": {
              "delivery-protocols": [
                "https/1.1"
              ]
            },
            "footprints": [
              <Footprint objects>
            ]
          }
        ]
      }
    }

EXAMPLE 2
    {
      "meta" : {...},
      "cdni-fci-map": {
        "capabilities": [
          {
            "capability-type": "FCI.DeliveryProtocol",
            "capability-value": {
              "delivery-protocols": [
                "https/1.1",
                "http/1.1"
              ]
            },
            "footprints": [
              <Footprint objects>
            ]
          }
        ]
      }
    }
]]></artwork>
            </figure>

                Since such optimizations are not necessary for the basic interconnection of CDNs, the specifics of such mechanisms are outside the scope of this document.
            </t>
<!--             <t>
            	Capability objects of a given capability type with identical footprint restrictions MUST be combined into a single capability object. And footprints with the same capability type and capability value MUST be combined into a single capability object.
            </t> -->
<!--             <t>
                Multiple BaseAdvertisementObject objects with the same capability type are allowed within a given CDNI FCI Map response as long as the capability option footprint-value do not overlap, i.e., a given capability option value MUST NOT show up in multiple BaseAdvertisementObject objects with the same capability type. If multiple BaseAdvertisementObject objects for a given capability type exist, those capability objects MUST have different footprint restrictions. Capability objects of a given capability type with identical footprint restrictions MUST be combined into a single capability object.
            </t> -->
<!--             <t>
                Multiple FCIMapData objects with the same capability type are allowed within a given CDNI FCI Map response as long as the capability option footprint-value do not overlap, i.e., a given capability option value MUST NOT show up in multiple FCIMapData objects within a single CDNI FCI Map response.  If multiple FCIMapData objects for a given capability type exist, those capability objects MUST have different footprint restrictions.  Capability objects of a given capability type with identical footprint restrictions MUST be combined into a single capability object.
            </t> -->
    	</section>
    	<section title="Examples">
    		<section title="IRD Example" anchor="IRDexample">
    			<t>
    				Below is the information resource directory (IRD) of a simple, example ALTO server. The server provides both base ALTO information resources (e.g., network maps) and CDNI FCI information resources (e.g., CDNI FCI map), demonstrating a single, integrated environment.
          </t>
          <t>
            Specifically, the IRD announces two network maps, one CDNI FCI map without dependency, one CDNI FCI map depending on a network map, one filtered CDNI FCI map to be defined in <xref target="filteredcdnifcimap"/>, one unified property map including "cdni-fci-capabilities" as its entities' property, one filtered unified property map including "cdni-fci-capabilities" and "pid" as its entities' properties, and two update stream services (one for updating CDNI FCI maps, and the other for updating property maps).
    			</t>
		    <figure align="left">
              <artwork align="left"><![CDATA[
 GET /directory HTTP/1.1
 Host: alto.example.com
 Accept: application/alto-directory+json,application/alto-error+json
]]></artwork>
            </figure>
		    <figure align="left">
              <artwork align="left"><![CDATA[
    {
      "meta" : { ... },
      "resources": {
        "my-default-network-map": {
          "uri" : "http://alto.example.com/networkmap",
          "media-type" : "application/alto-networkmap+json"
        },
        "my-eu-netmap" : {
          "uri" : "http://alto.example.com/myeunetmap",
          "media-type" : "application/alto-networkmap+json"
        },
        "my-default-cdnifci-map": {
          "uri" : "http://alto.example.com/cdnifcimap",
          "media-type": "application/alto-cdnifcimap+json"
        },
        "my-filtered-cdnifci-map" : {
          "uri" : "http://alto.example.com/cdnifcimap/filtered",
          "media-type" : "application/alto-cdnifcimap+json",
          "accepts" : "application/alto-cdnifcimapfilter+json",
          "uses" : [ "my-default-cdnifci-map" ]
        },
        "my-cdnifci-map-with-network-map-footprints": {
          "uri" : "http://alto.example.com/networkcdnifcimap",
          "media-type" : "application/alto-cdnifcimap+json",
          "uses" : [ "my-eu-netmap" ]
        },
        "cdnifci-property-map" : {
          "uri" : "http://alto.example.com/propmap/full/cdnifci",
          "media-type" : "application/alto-propmap+json",
          "capabilities" : {
            "domain-types" : [ "ipv4", "ipv6", "coutrycode", "asn" ],
            "prop-types" : [ "cdni-fci-capabilities" ]
          }
        },
        "filtered-cdnifci-property-map" : {
          "uri" : "http://alto.example.com/propmap/lookup/cdnifci-pid",
          "media-type" : "application/alto-propmap+json",
          "accepts" : "application/alto-propmapparams+json",
          "capabilities" : {
            "domain-types" : [ "ipv4", "ipv6", "coutrycode", "asn" ],
            "prop-types" : [ "cdni-fci-capabilities", "pid" ]
           }
        },
        "update-my-cdni-fci-maps" : {
          "uri": "http:///alto.example.com/updates/cdnifcimaps",
          "media-type" : "text/event-stream",
          "accepts" : "application/alto-updatestreamparams+json",
          "uses" : [
            "my-default-network-map",
            "my-eu-netmap",
            "my-default-cdnifci-map",
            "my-filtered-cdnifci-map"
            "my-cdnifci-map-with-network-map-footprints"
          ],
          "capabilities" : {
            "incremental-change-media-types" : {
              "my-default-network-map" : "application/json-patch+json",
              "my-eu-netmap" : "application/json-patch+json",
              "my-default-cdnifci-map" :
              "application/merge-patch+json,application/json-patch+json",
              "my-filtered-cdnifci-map" :
              "application/merge-patch+jso,application/json-patch+json",
              "my-cdnifci-map-with-network-map-footprints" :
              "application/merge-patch+json,application/json-patch+json"
            }
          }
        },
        "update-my-props": {
          "uri" : "http://alto.example.com/updates/properties",
          "media-type" : "text/event-stream",
          "uses" : [
            "cdnifci-property-map",
            "filtered-cdnifci-property-map"
          ],
          "capabilities" : {
            "incremental-change-media-types": {
              "cdnifci-property-map" :
              "application/merge-patch+json,application/json-patch+json",
              "filtered-cdnifci-property-map":
              "application/merge-patch+json,application/json-patch+json"
            }
          }
        }
      }
    }
    ]]></artwork>
            </figure>
    		</section>
    		<section title="Basic Example" anchor="fullcdnifcimap">
          <t>
            In this example, we demonstrate a simple CDNI FCI map; this map does not depend on other resources. There are three BaseAdvertisementObjects in this map and these objects' capabilities are http/1.1 delivery protocol, [http/1.1, https/1.1] delivery protocol and https/1.1 acquisition protocol respectively.
          </t>
		    <figure align="left">
              <artwork align="left"><![CDATA[
  GET /cdnifcimap HTTP/1.1
  Host: alto.example.com
  Accept: application/alto-cdnifcimap+json
  Accept: application/alto-error+json
]]></artwork>
            </figure>

		    <figure align="left">
              <artwork align="left"><![CDATA[
  HTTP/1.1 200 OK
  Content-Length: XXX
  Content-Type: application/alto-cdnifcimap+json
  {
    "meta" : {
      "vtag": {
        "resource-id": "my-default-cdnifci-map",
        "tag": "da65eca2eb7a10ce8b059740b0b2e3f8eb1d4785"
      }
    },
    "cdni-fci-map": {
      "capabilities": [
        {
          "capability-type": "FCI.DeliveryProtocol",
          "capability-value": {
            "delivery-protocols": [
              "http/1.1"
            ]
          },
          "footprints": [
            <Footprint objects>
          ]
        },
        {
          "capability-type": "FCI.DeliveryProtocol",
          "capability-value": {
            "delivery-protocols": [
              "https/1.1",
              "http/1.1"
            ]
          },
          "footprints": [
            <Footprint objects>
          ]
        },
        {
          "capability-type": "FCI.AcquisitionProtocol",
          "capability-value": {
            "acquisition-protocols": [
              "https/1.1"
            ]
          },
          "footprints": [
            <Footprint objects>
          ]
        }
      ]
    }
  }
]]></artwork>
            </figure>
    		</section>
    		<section title="Incremental Updates Example">
    			<t>
    				A benefit of using ALTO to provide CDNI FCI maps is that such maps can be updated using ALTO incremental updates. Below is an example that also shows the benefit of having both JSON merge patch and JSON patch to encode updates.
          </t>
          <t>
          At first, an ALTO client requests the ALTO server updates for "my-default-cdnifci-map", and the ALTO server returns the "control-uri" followed by the full CDNI FCI map. Then when there is a huge change in footprint objects in delivery-protocol http/1.1, the ALTO server uses JSON merge patch to encode the change and sends it to the ALTO client. Later on, the ALTO server notifies the ALTO client that "ipv4:192.0.2.0/24" is added into the footprints in delivery-protocol http/1.1 by sending the change encoded by JSON patch to the ALTO client.
    			</t>
        <figure align="left">
              <artwork align="left"><![CDATA[
  POST /updates/cdnifcimaps HTTP/1.1
  Host: alto.example.com
  Accept: text/event-stream,application/alto-error+json
  Content-Type: application/alto-updatestreamparams+json
  Content-Length: ###

  { "add": {
      "my-cdnifci-stream": {
          "resource-id": "my-default-cdnifci-map"
      }
  }

  HTTP/1.1 200 OK
  Connection: keep-alive
  Content-Type: text/event-stream

  event: application/alto-updatestreamcontrol+json
  data: {"control-uri":
  data: "http://alto.example.com/updates/streams/3141592653589"}

  event: application/alto-cdnifcimap+json,my-default-cdnifci-map
  data: { ... full CDNI FCI map ... }

  event: application/merge-patch+json,my-default-cdnifci-map
  data: {
  data:   "meta": {
  data:     "vtag": {
  data:       "tag": "dasdfa10ce8b059740bddsfasd8eb1d47853716"
  data:     }
  data:   },
  data:   {
  data:     "capability-type": "FCI.DeliveryProtocol",
  data:     "capability-value": {
  data:       "delivery-protocols": [
  data:         "http/1.1"
  data:       ]
  data:     },
  data:     "footprints": [
  data:       <Footprint objects that are different from
  data:        footprint objects in delivery-protocols http/1.1>
  data:     ]
  data:   }
  data: }

  event: application/json-patch+json,my-default-cdnifci-map
  data: [
  data:   {
  data:     "op": "replace",
  data:     "path": "/meta/vtag/tag",
  data:     "value": "a10ce8b059740b0b2e3f8eb1d4785acd42231bfe"
  data:   },
  data:   { "op": "add",
  data:     "path": "/cdni-fci-map/capabilities/0/footprints/-",
  data:     "value": "ipv4:192.0.2.0/24"
  data:   }
  data: ]
                ]]></artwork>
            </figure>
    		</section>
    	</section>
    </section>
